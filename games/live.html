<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Preview - AI Game Benchmark</title>

  <!-- Tailwind CSS v4.0 Output -->
  <link rel="stylesheet" href="../dist/output.css">

  <!-- Alpine.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.14.9/cdn.min.js" defer></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>

<body 
  x-data="livePageData()" 
  x-init="init()"
  @keydown.window.capture="handleHostArrowKey($event)"
  class="bg-bg-main text-text-primary"
>
  <!-- Theme Toggle -->
  <button 
    @click="toggleTheme()" 
    class="fixed top-6 right-6 z-50 p-2 text-text-secondary hover:text-text-primary transition-colors duration-300 group"
    aria-label="Toggle Theme"
  >
    <div class="relative w-6 h-6">
      <div x-show="!darkMode" class="absolute inset-0">
        <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
      </div>
      <div x-show="darkMode" class="absolute inset-0">
        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
        </svg>
      </div>
    </div>
  </button>


  <!-- Navigation Header -->
  <nav class="sticky top-0 z-40 bg-bg-main/80 backdrop-blur-md border-b border-border transition-colors duration-300" role="navigation">
    <div class="container-custom py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a :href="'./' + gameId + '/'" class="p-2 hover:bg-bg-card rounded-full transition-all duration-300 text-text-secondary hover:text-text-primary" title="Back to game list">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
        </a>
        <div class="h-6 w-px bg-border transition-colors duration-300" aria-hidden="true"></div>
        <div class="flex items-center gap-2">
          <span class="text-2xl" x-text="gameConfig?.emoji || 'üéÆ'"></span>
          <h1 class="text-xl md:text-2xl font-bold tracking-tight text-text-primary" x-text="gameConfig?.title"></h1>
        </div>
      </div>
      
      <!-- Navigation Actions -->
      <div class="flex items-center gap-4 md:gap-8 transition-all duration-300">
        <!-- View Switcher (Desktop) -->
        <div class="hidden md:flex items-center bg-bg-card border border-border rounded-full p-1 shadow-sm">
          <a :href="'./' + gameId + '/index.html'" class="px-4 py-1.5 rounded-full text-xs font-bold text-text-secondary hover:text-text-primary transition-all duration-300">List View</a>
          <div class="px-4 py-1.5 rounded-full text-xs font-bold bg-accent text-white shadow-md transition-all duration-300">Live Preview</div>
        </div>

        <!-- View Prompt (Desktop) -->
        <a 
          :href="getPromptUrl()" 
          target="_blank"
          rel="noopener noreferrer"
          class="hidden md:flex items-center gap-1.5 text-sm font-medium text-accent hover:text-accent-hover transition-colors duration-300"
        >
          <span>View Prompt</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
        </a>

        <!-- Stats (Desktop) -->
        <div class="hidden md:flex items-center gap-8 text-sm">
          <div class="flex flex-col items-end transition-all duration-300">
            <span class="text-text-muted text-xs uppercase tracking-widest transition-colors duration-300">Models Tested</span>
            <span class="font-bold text-accent transition-colors duration-300" x-text="gameConfig?.models?.length || 0"></span>
          </div>
          <div class="flex flex-col items-end transition-all duration-300">
            <span class="text-text-muted text-xs uppercase tracking-widest transition-colors duration-300">Passed</span>
            <span class="font-bold text-text-primary transition-colors duration-300" x-text="passedCount"></span>
          </div>
        </div>


      </div>
    </div>
  </nav>

  <!-- Mobile Actions -->
  <div class="md:hidden container-custom pt-6 flex flex-col gap-4">
    <div class="flex gap-4 p-4 bg-bg-card rounded-2xl border border-border">
      <div class="flex-1 text-center">
        <div class="text-[10px] text-text-muted uppercase mb-1">Models Tested</div>
        <div class="font-bold text-accent" x-text="gameConfig?.models?.length || 0"></div>
      </div>
      <div class="flex-1 text-center border-l border-border">
        <div class="text-[10px] text-text-muted uppercase mb-1">Passed</div>
        <div class="font-bold text-text-primary" x-text="passedCount"></div>
      </div>
    </div>
    <div class="flex items-center bg-bg-card border border-border rounded-xl p-1 shadow-sm">
      <a :href="'./' + gameId + '/index.html'" class="flex-1 px-4 py-2 rounded-lg text-center text-xs font-bold text-text-secondary transition-all duration-300">List View</a>
      <div class="flex-1 px-4 py-2 rounded-lg text-center text-xs font-bold bg-accent text-white shadow-md transition-all duration-300">Live Preview</div>
    </div>
    <a :href="getPromptUrl()" target="_blank" class="btn-secondary w-full py-2 text-xs flex items-center justify-center gap-2">üìù View Prompt</a>
  </div>

  <!-- Models Live Grid -->
  <section class="py-8 md:py-12">
    <div class="container-custom">
      <div x-show="loading" class="text-center py-20">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-accent"></div>
        <p class="mt-4 text-text-secondary">Initializing live environments...</p>
      </div>

      <div x-show="!loading && gameConfig" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <template x-for="model in gameConfig?.models || []" :key="model.id">
          <div 
            class="bg-bg-card border border-border rounded-2xl overflow-hidden shadow-lg transition-all duration-300"
            x-data="{ 
              active: false, 
              currentVersion: 'r1',
              scale: 1,
              containerHeight: 400,
              baseWidth: 1280,
              baseHeight: 800,
              updateScale() {
                const w = this.$refs.cardContainer.clientWidth;
                this.scale = w / this.baseWidth;
                this.containerHeight = this.baseHeight * this.scale;
              }
            }"
            x-init="window.addEventListener('resize', () => updateScale()); $nextTick(() => updateScale())"
            @click.away="active = false; $dispatch('unlock-scroll')"
          >
            <!-- Card Header -->
            <div class="px-6 py-4 border-b border-border flex items-center justify-between bg-bg-main/30">
              <div class="flex items-center gap-3">
                <div :class="getStatusColorClass(model.status)" class="w-2.5 h-2.5 rounded-full shadow-sm"></div>
                <div>
                  <h3 class="font-bold text-text-primary text-sm" x-text="model.name"></h3>
                  <div class="text-[10px] text-text-muted uppercase tracking-widest" x-text="model.status"></div>
                </div>
              </div>
              <div class="flex items-center bg-bg-main/50 border border-border rounded-lg p-0.5">
                <button @click="currentVersion = 'r1'; active = false" :class="currentVersion === 'r1' ? 'bg-accent text-white' : 'text-text-secondary hover:text-text-primary'" class="px-3 py-1 rounded text-[10px] font-bold transition-all duration-300">R1</button>
                <button x-show="model.r2_file" @click="currentVersion = 'r2'; active = false" :class="currentVersion === 'r2' ? 'bg-accent text-white' : 'text-text-secondary hover:text-text-primary'" class="px-3 py-1 rounded text-[10px] font-bold transition-all duration-300">R2</button>
              </div>
            </div>
            <!-- Game Container -->
            <div x-ref="cardContainer" class="relative bg-[#000] overflow-hidden group" :style="`height: ${containerHeight}px;`">
              <div class="absolute top-0 left-0 origin-top-left" :style="`width: ${baseWidth}px; height: ${baseHeight}px; transform: scale(${scale});`"><iframe x-ref="gameIframe" :src="currentVersion === 'r2' ? model.r2_file : model.r1_file" class="w-full h-full border-0" scrolling="no" :class="!active ? 'pointer-events-none' : ''" @load="updateScale(); $dispatch('inject-monitor', { iframe: $refs.gameIframe, modelId: model.id })"></iframe></div>
              <div x-show="!active" @click="active = true; $dispatch('lock-scroll'); $nextTick(() => { $refs.gameIframe.focus(); $dispatch('inject-controls', { iframe: $refs.gameIframe }); })" class="absolute inset-0 z-10 bg-bg-main/40 backdrop-blur-[1px] flex items-center justify-center cursor-pointer group-hover:bg-bg-main/20 transition-all duration-300"><div class="px-4 py-2 bg-bg-card/90 border border-border rounded-xl shadow-xl text-xs font-bold text-text-primary scale-90 group-hover:scale-100 transition-transform duration-300">Click to Interact</div></div>
              <div x-show="active" class="absolute top-3 right-3 z-20 pointer-events-none flex flex-col items-end gap-1.5">
                <div class="bg-accent/90 text-white text-[8px] font-bold px-2 py-0.5 rounded-full uppercase tracking-tighter flex items-center gap-1 shadow-lg backdrop-blur-md">
                  <span class="relative flex h-1.5 w-1.5">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-white"></span>
                  </span>
                  Active
                </div>
                <!-- FPS Badge -->
                <div x-data="{ fps: 0 }" 
                     x-init="window.addEventListener('message', (e) => { if(e.data?.type === 'fps' && e.data?.modelId === model.id) fps = e.data.value })"
                     x-show="fps > 0"
                     :class="fps < 15 ? 'bg-red-500/90' : (fps < 30 ? 'bg-yellow-500/90' : 'bg-green-500/90')"
                     class="text-white text-[8px] font-bold px-2 py-0.5 rounded-full shadow-lg backdrop-blur-md transition-all duration-300">
                  <span x-text="fps"></span> FPS
                </div>
              </div>
            </div>
            <div class="px-6 py-3 bg-bg-main/10"><p class="text-[11px] text-text-secondary leading-tight line-clamp-2 italic" x-text="model.notes"></p></div>
          </div>
        </template>
      </div>
    </div>
  </section>

  <script>
    function livePageData() {
      return {
        darkMode: localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches),
        toggleTheme() {
          this.darkMode = !this.darkMode;
          localStorage.setItem('theme', this.darkMode ? 'dark' : 'light');
        },
        gameId: '', gameConfig: null, loading: true, savedScrollY: 0, anyGameActive: false,
        get passedCount() { return this.gameConfig?.models?.filter(m => m.status === 'Pass').length || 0; },
        getPromptUrl() { return `../prompts/${this.gameId}.md`; },
        async init() {
          this.$watch('darkMode', val => val ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark'));
          this.darkMode ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark');

          const urlParams = new URLSearchParams(window.location.search);
          this.gameId = urlParams.get('game') || 'snake';
          await this.loadData();
          window.addEventListener('lock-scroll', () => this.lockScroll());
          window.addEventListener('unlock-scroll', () => this.unlockScroll());

          // Listen for injection requests
          window.addEventListener('inject-monitor', (e) => this.injectFPSMonitor(e.detail.iframe, e.detail.modelId));
          window.addEventListener('inject-controls', (e) => this.injectIframeControls(e.detail.iframe));
        },
        async loadData() {
          const res = await fetch('../data/games.json');
          const games = await res.json();
          this.gameConfig = games[this.gameId];
          this.loading = false;
        },
        lockScroll() {
          this.anyGameActive = true; this.savedScrollY = window.scrollY;
          const sw = window.innerWidth - document.documentElement.clientWidth;
          document.body.style.overflow = 'hidden'; document.body.style.paddingRight = `${sw}px`;
          document.documentElement.classList.remove('scroll-smooth');
        },
        unlockScroll() {
          this.anyGameActive = false; document.body.style.overflow = ''; document.body.style.paddingRight = '';
          document.documentElement.classList.add('scroll-smooth'); window.scrollTo(0, this.savedScrollY);
        },
        injectIframeControls(iframe) {
          try {
            if (iframe?.contentWindow) {
              iframe.contentWindow.addEventListener('keydown', (e) => {
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) e.preventDefault();
                if (e.key === 'Escape') this.handleHostArrowKey({ key: 'Escape', preventDefault: () => {}, stopPropagation: () => {} });
              }, true);
            }
          } catch (e) {}
        },
        injectFPSMonitor(iframe, modelId) {
          try {
            if (iframe?.contentWindow) {
              const script = `
                (function() {
                  let frameCount = 0;
                  let lastTime = performance.now();
                  function updateFPS() {
                    frameCount++;
                    const now = performance.now();
                    if (now - lastTime >= 1000) {
                      const fps = Math.round((frameCount * 1000) / (now - lastTime));
                      window.parent.postMessage({ type: 'fps', value: fps, modelId: '${modelId}' }, '*');
                      frameCount = 0;
                      lastTime = now;
                    }
                    requestAnimationFrame(updateFPS);
                  }
                  requestAnimationFrame(updateFPS);
                })();
              `;
              const scriptElement = iframe.contentWindow.document.createElement('script');
              scriptElement.textContent = script;
              (iframe.contentWindow.document.head || iframe.contentWindow.document.documentElement).appendChild(scriptElement);
            }
          } catch (e) {}
        },
        handleHostArrowKey(e) {
          if (e.key === 'Escape') { 
            this.unlockScroll(); 
            // Trigger a click away for all active states
            document.body.click(); 
            return;
          }
          if (this.anyGameActive && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' ', 'Tab'].includes(e.key)) {
            e.preventDefault();
            e.stopPropagation();
          }
        },
        getStatusColorClass(status) {
          return {
            Pass: 'bg-green-500',
            Fixed: 'bg-yellow-500',
            Failed: 'bg-red-500'
          }[status] || 'bg-gray-400';
        }
      };
    }
  </script>
</body>
</html>
